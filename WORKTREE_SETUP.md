# Worktree Setup - Quick Start for Agents

**Critical:** Agents must be able to create worktrees and test rapidly. Follow this exact sequence.

## 1. Create Worktree (30 seconds)

```bash
# From main repo
git worktree add -b your-branch-name ../your-worktree-name

# Navigate to worktree
cd ../your-worktree-name
```

## 2. Environment Setup (60 seconds)

### Option A: Automated Setup (Recommended)
```bash
# Run the automated setup script
./scripts/setup-worktree.sh
```

### Option B: Manual Setup
```bash
# Copy secrets from parent repo (CRITICAL STEP)
cp /Users/the_dusky/code/emprops/conductor/emp-job-queue/config/environments/secrets/.env.secrets.local config/environments/secrets/.env.secrets.local

# OR use 1Password CLI (if available)
op read --out-file ./config/environments/secrets/.env.secrets.local op://emerge/jobqenv.secrets/.env.secrets.local --force

# Install dependencies
pnpm install

# Build environment for local-dev profile
pnpm env:build local-dev

# Build the project
pnpm build
```

## 3. Verify Setup (10 seconds)

```bash
# Check that environment files were created
ls -la .env apps/api/.env apps/worker/.env

# Verify secrets are present
test -f config/environments/secrets/.env.secrets.local && echo "✅ Secrets configured" || echo "❌ Secrets missing"
```

## 4. Test Readiness Check (30 seconds)

```bash
# Verify Redis connection (local Redis)
redis-cli -h localhost -p 6379 ping

# OR verify remote Redis connection
REDIS_URL=$(grep REDIS_URL apps/api/.env | cut -d= -f2)
redis-cli -u "$REDIS_URL" ping

# Should return: PONG
```

## 5. Quick Test Commands

### Test Telemetry Client
```bash
# Simple telemetry test using EventClient
REDIS_URL=redis://localhost:6379 node --input-type=module -e "
import { EventClient } from '@emp/core';
const client = new EventClient('worktree-test', 'redis://localhost:6379');
await client.event('worktree.setup.test', {
  message: 'Worktree setup verification',
  timestamp: new Date().toISOString()
});
console.log('✅ Telemetry works');
await client.close();
"
```

### Start Services
```bash
# Terminal 1: Start collector
cd apps/telemetry-collector && pnpm dev

# Terminal 2: Start API
pnpm dev:api

# Terminal 3: Start worker
pnpm dev:worker
```

## 6. Verification

After setup, you should be able to:
- ✅ Connect to Redis
- ✅ Build all packages
- ✅ Send telemetry events
- ✅ Start all services

## Common Issues

**Missing secrets file**: Run `./scripts/setup-worktree.sh` or manually copy from parent
**Redis connection failed**: Verify `redis-cli -h localhost -p 6379 ping` works
**Build errors**: Ensure `pnpm install` completed successfully
**Environment files missing**: Run `pnpm env:build local-dev`
**Package not found**: Run full build with `pnpm build`

## Files You Need

```
config/environments/secrets/.env.secrets.local  # Copied from parent or 1Password
.env                                             # Generated by pnpm env:build
apps/api/.env                                    # Generated by pnpm env:build
apps/worker/.env                                 # Generated by pnpm env:build
apps/monitor/.env.local                          # Generated by pnpm env:build
node_modules/                                    # Generated by pnpm install
packages/*/dist/                                 # Generated by pnpm build
apps/*/dist/                                     # Generated by pnpm build
```

## Automated Setup Script

The `scripts/setup-worktree.sh` script handles all setup automatically:
- Fetches secrets from 1Password (if available) or copies from parent repo
- Installs dependencies
- Builds environment files for local-dev profile
- Builds the entire project
- Verifies all critical files are present

**Total Setup Time: ~4 minutes (automated) or ~5 minutes (manual)**