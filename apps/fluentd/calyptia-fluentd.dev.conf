# Calyptia Fluentd Configuration - DEVELOPMENT
# Simple HTTP input -> Dash0 output

# System configuration for debugging
<system>
  log_level debug
</system>

# HTTP Input - receives logs on port 8888
<source>
  @type http
  port 8888
  bind 0.0.0.0
</source>

# Monitoring endpoint
<source>
  @type monitor_agent
  port 24220
  bind 0.0.0.0
</source>

# Handle Fluentd's own logs (removes the warning)
<label @FLUENT_LOG>
  <match fluent.**>
    @type null
  </match>
</label>

# Convert epoch date to ISO timestamp
<filter **>
  @type record_transformer
  <record>
    timestamp ${Time.at(record["date"]).strftime('%Y-%m-%dT%H:%M:%S.%3NZ')}
  </record>
</filter>

# Debug: Log all received messages to console
<match **>
  @type copy
  
  # Send to Dash0
  <store>
    @type http
    endpoint https://ingress.us-west-2.aws.dash0.com/logs/json
    http_method post
    headers {"Authorization":"Bearer auth_w8VowQspnZ8whZHWp1pe6azIIehBAAvL","Content-Type":"application/json","Dash0-Dataset":"development"}
    
    # Enable verbose logging to see HTTP responses
    open_timeout 10
    read_timeout 30
    
    <format>
      @type json
    </format>
    
    <buffer>
      @type memory
      flush_interval 5s
    </buffer>
  </store>
  
  # Also log to console for debugging
  <store>
    @type stdout
  </store>
</match>