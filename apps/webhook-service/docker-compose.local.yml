version: '3.8'

services:
  webhook-service:
    build:
      context: .
      dockerfile: Dockerfile.local
      args:
        CACHE_BUST: ${CACHE_BUST:-1}
        BUILD_TIMESTAMP: ${BUILD_TIMESTAMP:-}
        MACHINE_ID: webhook-local
        ENV_FILE: .env.local-dev
    image: emprops/webhook:local-dev
    container_name: webhook-service
    hostname: webhook-service
    restart: unless-stopped
    ports:
      - "3332:3332"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      WEBHOOK_PORT: 3332
      MACHINE_ID: webhook-local
      # Redis configuration
      HUB_REDIS_URL: ${HUB_REDIS_URL:-redis://host.docker.internal:6379}
      # OTEL configuration
      OTEL_ENABLED: ${OTEL_ENABLED:-true}
      OTEL_LOG_LEVEL: ${OTEL_LOG_LEVEL:-info}
      OTEL_DEBUG_VERBOSITY: ${OTEL_DEBUG_VERBOSITY:-normal}
      OTEL_COLLECTOR_TRACES_ENDPOINT: ${OTEL_COLLECTOR_TRACES_ENDPOINT:-http://localhost:4318/v1/traces}
      OTEL_COLLECTOR_METRICS_ENDPOINT: ${OTEL_COLLECTOR_METRICS_ENDPOINT:-http://localhost:4318/v1/metrics}
      OTEL_SERVICE_NAME: webhook-service
      OTEL_SERVICE_VERSION: ${SERVICE_VERSION:-1.0.0}
      # Dash0 configuration
      DASH0_API_KEY: ${DASH0_API_KEY:-}
      DASH0_ENDPOINT: ${DASH0_ENDPOINT:-https://ingress.us-west-2.aws.dash0.com:4317}
      DASH0_METRICS_ENDPOINT: ${DASH0_METRICS_ENDPOINT:-https://ingress.us-west-2.aws.dash0.com/v1/metrics}
      # Fluent Bit configuration
      FLUENT_BIT_ENABLED: ${FLUENT_BIT_ENABLED:-true}
      FLUENT_BIT_LOG_LEVEL: ${FLUENT_BIT_LOG_LEVEL:-info}
      FLUENTD_HOST: ${FLUENTD_HOST:-host.docker.internal}
      FLUENTD_PORT: ${FLUENTD_PORT:-24224}
      FLUENTD_SECURE: ${FLUENTD_SECURE:-off}
      FLUENTD_SHARED_KEY: ${FLUENTD_SHARED_KEY:-}
    networks:
      - emp-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3332/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  emp-network:
    external: true
    name: emp-job-queue